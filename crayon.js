let list = "data/images/1/part-1-0.jpg, data/images/1/part-1-1.jpg, data/images/1/part-1-10.jpg, data/images/1/part-1-11.jpg, data/images/1/part-1-12.jpg, data/images/1/part-1-13.jpg, data/images/1/part-1-14.jpg, data/images/1/part-1-15.jpg, data/images/1/part-1-16.jpg, data/images/1/part-1-17.jpg, data/images/1/part-1-18.jpg, data/images/1/part-1-2.jpg, data/images/1/part-1-3.jpg, data/images/1/part-1-4.jpg, data/images/1/part-1-5.jpg, data/images/1/part-1-6.jpg, data/images/1/part-1-7.jpg, data/images/1/part-1-8.jpg, data/images/1/part-1-9.jpg, data/images/10/part-10-0.jpg, data/images/10/part-10-1.jpg, data/images/10/part-10-10.jpg, data/images/10/part-10-11.jpg, data/images/10/part-10-12.jpg, data/images/10/part-10-13.jpg, data/images/10/part-10-14.jpg, data/images/10/part-10-15.jpg, data/images/10/part-10-16.jpg, data/images/10/part-10-17.jpg, data/images/10/part-10-18.jpg, data/images/10/part-10-2.jpg, data/images/10/part-10-3.jpg, data/images/10/part-10-4.jpg, data/images/10/part-10-5.jpg, data/images/10/part-10-6.jpg, data/images/10/part-10-7.jpg, data/images/10/part-10-8.jpg, data/images/10/part-10-9.jpg, data/images/11/part-11-0.jpg, data/images/11/part-11-1.jpg, data/images/11/part-11-10.jpg, data/images/11/part-11-11.jpg, data/images/11/part-11-12.jpg, data/images/11/part-11-13.jpg, data/images/11/part-11-14.jpg, data/images/11/part-11-15.jpg, data/images/11/part-11-16.jpg, data/images/11/part-11-17.jpg, data/images/11/part-11-18.jpg, data/images/11/part-11-2.jpg, data/images/11/part-11-3.jpg, data/images/11/part-11-4.jpg, data/images/11/part-11-5.jpg, data/images/11/part-11-6.jpg, data/images/11/part-11-7.jpg, data/images/11/part-11-8.jpg, data/images/11/part-11-9.jpg, data/images/12/part-12-0.jpg, data/images/12/part-12-1.jpg, data/images/12/part-12-10.jpg, data/images/12/part-12-11.jpg, data/images/12/part-12-12.jpg, data/images/12/part-12-13.jpg, data/images/12/part-12-14.jpg, data/images/12/part-12-15.jpg, data/images/12/part-12-16.jpg, data/images/12/part-12-17.jpg, data/images/12/part-12-18.jpg, data/images/12/part-12-2.jpg, data/images/12/part-12-3.jpg, data/images/12/part-12-4.jpg, data/images/12/part-12-5.jpg, data/images/12/part-12-6.jpg, data/images/12/part-12-7.jpg, data/images/12/part-12-8.jpg, data/images/12/part-12-9.jpg, data/images/13/part-13-0.jpg, data/images/13/part-13-1.jpg, data/images/13/part-13-10.jpg, data/images/13/part-13-11.jpg, data/images/13/part-13-12.jpg, data/images/13/part-13-13.jpg, data/images/13/part-13-14.jpg, data/images/13/part-13-15.jpg, data/images/13/part-13-16.jpg, data/images/13/part-13-17.jpg, data/images/13/part-13-18.jpg, data/images/13/part-13-2.jpg, data/images/13/part-13-3.jpg, data/images/13/part-13-4.jpg, data/images/13/part-13-5.jpg, data/images/13/part-13-6.jpg, data/images/13/part-13-7.jpg, data/images/13/part-13-8.jpg, data/images/13/part-13-9.jpg, data/images/2/part-2-0.jpg, data/images/2/part-2-1.jpg, data/images/2/part-2-10.jpg, data/images/2/part-2-11.jpg, data/images/2/part-2-12.jpg, data/images/2/part-2-13.jpg, data/images/2/part-2-14.jpg, data/images/2/part-2-15.jpg, data/images/2/part-2-16.jpg, data/images/2/part-2-17.jpg, data/images/2/part-2-18.jpg, data/images/2/part-2-2.jpg, data/images/2/part-2-3.jpg, data/images/2/part-2-4.jpg, data/images/2/part-2-5.jpg, data/images/2/part-2-6.jpg, data/images/2/part-2-7.jpg, data/images/2/part-2-8.jpg, data/images/2/part-2-9.jpg, data/images/3/part-3-0.jpg, data/images/3/part-3-1.jpg, data/images/3/part-3-10.jpg, data/images/3/part-3-11.jpg, data/images/3/part-3-12.jpg, data/images/3/part-3-13.jpg, data/images/3/part-3-14.jpg, data/images/3/part-3-15.jpg, data/images/3/part-3-16.jpg, data/images/3/part-3-17.jpg, data/images/3/part-3-18.jpg, data/images/3/part-3-2.jpg, data/images/3/part-3-3.jpg, data/images/3/part-3-4.jpg, data/images/3/part-3-5.jpg, data/images/3/part-3-6.jpg, data/images/3/part-3-7.jpg, data/images/3/part-3-8.jpg, data/images/3/part-3-9.jpg, data/images/4/part-4-0.jpg, data/images/4/part-4-1.jpg, data/images/4/part-4-10.jpg, data/images/4/part-4-11.jpg, data/images/4/part-4-12.jpg, data/images/4/part-4-13.jpg, data/images/4/part-4-14.jpg, data/images/4/part-4-15.jpg, data/images/4/part-4-16.jpg, data/images/4/part-4-17.jpg, data/images/4/part-4-18.jpg, data/images/4/part-4-2.jpg, data/images/4/part-4-3.jpg, data/images/4/part-4-4.jpg, data/images/4/part-4-5.jpg, data/images/4/part-4-6.jpg, data/images/4/part-4-7.jpg, data/images/4/part-4-8.jpg, data/images/4/part-4-9.jpg, data/images/5/part-5-0.jpg, data/images/5/part-5-1.jpg, data/images/5/part-5-10.jpg, data/images/5/part-5-11.jpg, data/images/5/part-5-12.jpg, data/images/5/part-5-13.jpg, data/images/5/part-5-14.jpg, data/images/5/part-5-15.jpg, data/images/5/part-5-16.jpg, data/images/5/part-5-17.jpg, data/images/5/part-5-18.jpg, data/images/5/part-5-2.jpg, data/images/5/part-5-3.jpg, data/images/5/part-5-4.jpg, data/images/5/part-5-5.jpg, data/images/5/part-5-6.jpg, data/images/5/part-5-7.jpg, data/images/5/part-5-8.jpg, data/images/5/part-5-9.jpg, data/images/6/part-6-0.jpg, data/images/6/part-6-1.jpg, data/images/6/part-6-10.jpg, data/images/6/part-6-11.jpg, data/images/6/part-6-12.jpg, data/images/6/part-6-13.jpg, data/images/6/part-6-14.jpg, data/images/6/part-6-15.jpg, data/images/6/part-6-16.jpg, data/images/6/part-6-17.jpg, data/images/6/part-6-18.jpg, data/images/6/part-6-2.jpg, data/images/6/part-6-3.jpg, data/images/6/part-6-4.jpg, data/images/6/part-6-5.jpg, data/images/6/part-6-6.jpg, data/images/6/part-6-7.jpg, data/images/6/part-6-8.jpg, data/images/6/part-6-9.jpg, data/images/7/part-7-0.jpg, data/images/7/part-7-1.jpg, data/images/7/part-7-10.jpg, data/images/7/part-7-11.jpg, data/images/7/part-7-12.jpg, data/images/7/part-7-13.jpg, data/images/7/part-7-14.jpg, data/images/7/part-7-15.jpg, data/images/7/part-7-16.jpg, data/images/7/part-7-17.jpg, data/images/7/part-7-18.jpg, data/images/7/part-7-2.jpg, data/images/7/part-7-3.jpg, data/images/7/part-7-4.jpg, data/images/7/part-7-5.jpg, data/images/7/part-7-6.jpg, data/images/7/part-7-7.jpg, data/images/7/part-7-8.jpg, data/images/7/part-7-9.jpg, data/images/8/part-8-0.jpg, data/images/8/part-8-1.jpg, data/images/8/part-8-10.jpg, data/images/8/part-8-11.jpg, data/images/8/part-8-12.jpg, data/images/8/part-8-13.jpg, data/images/8/part-8-14.jpg, data/images/8/part-8-15.jpg, data/images/8/part-8-16.jpg, data/images/8/part-8-17.jpg, data/images/8/part-8-18.jpg, data/images/8/part-8-2.jpg, data/images/8/part-8-3.jpg, data/images/8/part-8-4.jpg, data/images/8/part-8-5.jpg, data/images/8/part-8-6.jpg, data/images/8/part-8-7.jpg, data/images/8/part-8-8.jpg, data/images/8/part-8-9.jpg, data/images/9/part-9-0.jpg, data/images/9/part-9-1.jpg, data/images/9/part-9-10.jpg, data/images/9/part-9-11.jpg, data/images/9/part-9-12.jpg, data/images/9/part-9-13.jpg, data/images/9/part-9-14.jpg, data/images/9/part-9-15.jpg, data/images/9/part-9-16.jpg, data/images/9/part-9-17.jpg, data/images/9/part-9-18.jpg, data/images/9/part-9-2.jpg, data/images/9/part-9-3.jpg, data/images/9/part-9-4.jpg, data/images/9/part-9-5.jpg, data/images/9/part-9-6.jpg, data/images/9/part-9-7.jpg, data/images/9/part-9-8.jpg, data/images/9/part-9-9.jpg, ";
const svgNS = "http://www.w3.org/2000/svg";

function cut_dir(path){
	return path.substring(path.lastIndexOf("/")+1);
}

function begin() {
	//imgs = getList().split(", ");
	imgs = list.split(", ");
	imgs = imgs.map(x => x.replace("'", ""));
	imgs = imgs.map(x => x.replace("'", ""));
	current = 0;
	setupDraw(imgs[current]);
}

let dir = "../nexus/part_photos/1/";
let current;
let imgs = [];
let body_node;
let container_node;
let image_node;
let clicks;
let cords;
let polygon = [];
let point_node;
let color;

function setupDraw(img) {
	body_node = document.body;
	container_node = document.getElementById("canvas");
	image_node = document.getElementById("img");
	image_node.setAttribute("src", img);
	svg_node = document.getElementById('svg');
	svg_node.innerHTML = '';
	//wait for image to load and then draw vector canvas
	image_node.onload = (event) => {
		let w = image_node.offsetWidth;
		let h = image_node.offsetHeight;
		svg_node.setAttribute("viewbox",  `0, 0, ${w}, ${h}`);
		svg_node.setAttribute("width", w);
		svg_node.setAttribute("height", h);
		container_node.appendChild(svg_node);
	}

	svg_node.onclick = function(click){handler(click)};
	clicks = 0;
	cords;
	polygon = [];
	point_node;
	color = "yellow";
}

function next(save) {
	current += 1;
	setupDraw(imgs[current]);
	if(save){saveCords();}
}

function handler(click) {
	cords = [click.offsetX, click.offsetY];
	polygon.push(cords);
	clicks += 1;
	if(clicks==1){
		paintPoint(cords);
		return;
	}
	if(complete(cords)){
		paintLine(polygon[clicks-2], polygon[0]);
		//make these cords the same as the starting ones
		polygon[clicks-1]=polygon[0];
		changeColor("Chartreuse");
		saveCords();
		next(false);
	} else {
		paintPoint(cords);
		paintLine(polygon[clicks-2], polygon[clicks-1]);
	}
}
function paintPoint(cords) {
	point_node = document.createElementNS(svgNS, 'circle');
	point_node.setAttribute("cx", cords[0]);
	point_node.setAttribute("cy", cords[1]);
	point_node.setAttribute("r", 5);
	point_node.setAttribute("fill", color);
	svg_node.appendChild(point_node);
}

function paintLine(cords1, cords2) {
	line_node = document.createElementNS(svgNS, 'line');
	line_node.setAttribute("x1", cords1[0]);
	line_node.setAttribute("y1", cords1[1]);
	line_node.setAttribute("x2", cords2[0]);
	line_node.setAttribute("y2", cords2[1]);
	line_node.setAttribute("stroke", color);
	line_node.setAttribute("stroke-width", 5);
	svg_node.appendChild(line_node);
}

function complete(cords) {
	threshold = 5;
	if (Math.abs(cords[0]-polygon[0][0]) < threshold && Math.abs(cords[1]-polygon[0][1]) < threshold) {
		return true;
	} else {return false;}
}

function changeColor(color) {
	for(let i=0;i<svg_node.children.length;i++){
		svg_node.children[i].setAttribute("stroke", color);
		svg_node.children[i].setAttribute("fill", color);
	}
}

function saveCords() {
	let cords_string = "";
	for(let i=0;i<polygon.length;i++){
		cords_string += `${polygon[i][0]} ${polygon[i][1]}\n`;
	}
	download(cords_string, `${cut_dir(imgs[current])}.txt`, "text");
}

// Function to download data to a file
function download(data, filename, type) {
    var file = new Blob([data], {type: type});
    if (window.navigator.msSaveOrOpenBlob) // IE10+
        window.navigator.msSaveOrOpenBlob(file, filename);
    else { // Others
        var a = document.createElement("a"),
                url = URL.createObjectURL(file);
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(function() {
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);  
        }, 0); 
    }
}

function printCords() {
	for(i=0; i<polygon.length; i++) {
		console.log(polygon[i])
	}
}

function getList() {
	let input_node = document.getElementById("list");
	return input_node.value;
}
